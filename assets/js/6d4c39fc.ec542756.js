(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[90336],{3905:function(e,t,n){"use strict";n.d(t,{Zo:function(){return d},kt:function(){return p}});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),c=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},d=function(e){var t=c(e.components);return a.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,l=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),m=c(n),p=r,h=m["".concat(l,".").concat(p)]||m[p]||u[p]||o;return n?a.createElement(h,i(i({ref:t},d),{},{components:n})):a.createElement(h,i({ref:t},d))}));function p(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=m;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:r,i[1]=s;for(var c=2;c<o;c++)i[c]=n[c];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},31167:function(e,t,n){"use strict";n.r(t),n.d(t,{frontMatter:function(){return i},contentTitle:function(){return s},metadata:function(){return l},toc:function(){return c},default:function(){return u}});var a=n(74034),r=n(79973),o=(n(67294),n(3905)),i={title:"Seeding"},s=void 0,l={unversionedId:"seeding",id:"seeding",isDocsHomePage:!1,title:"Seeding",description:"When initializing your application or testing it can be exhausting to create sample data for your database. The solution is to use seeding. Create factories for your entities and use them in the seed script or combine multiple seed scripts.",source:"@site/docs/seeding.md",sourceDirName:".",slug:"/seeding",permalink:"/docs/next/seeding",editUrl:"https://github.com/mikro-orm/mikro-orm/edit/master/docs/docs/seeding.md",tags:[],version:"current",lastUpdatedBy:"Renovate Bot",lastUpdatedAt:1633976347,formattedLastUpdatedAt:"10/11/2021",frontMatter:{title:"Seeding"},sidebar:"docs",previous:{title:"Migrations",permalink:"/docs/next/migrations"},next:{title:"Read Replica Connections",permalink:"/docs/next/read-connections"}},c=[{value:"Seeders",id:"seeders",children:[{value:"Using entity factories",id:"using-entity-factories",children:[]},{value:"Calling additional seeders",id:"calling-additional-seeders",children:[]}]},{value:"Entity factories",id:"entity-factories",children:[{value:"Creating entities using factories",id:"creating-entities-using-factories",children:[]},{value:"Persisting entities",id:"persisting-entities",children:[]},{value:"Factory relationships",id:"factory-relationships",children:[]}]},{value:"Use with CLI",id:"use-with-cli",children:[]},{value:"Use in tests",id:"use-in-tests",children:[]}],d={toc:c};function u(e){var t=e.components,n=(0,r.Z)(e,["components"]);return(0,o.kt)("wrapper",(0,a.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("p",null,"When initializing your application or testing it can be exhausting to create sample data for your database. The solution is to use seeding. Create factories for your entities and use them in the seed script or combine multiple seed scripts."),(0,o.kt)("h2",{id:"seeders"},"Seeders"),(0,o.kt)("p",null,"A seeder class contains one method ",(0,o.kt)("inlineCode",{parentName:"p"},"run"),". This method is called when you use the command ",(0,o.kt)("inlineCode",{parentName:"p"},"npx mikro-orm seeder:run"),". In the ",(0,o.kt)("inlineCode",{parentName:"p"},"run")," method you define how and what data you want to insert into the database. You can create entities using the ",(0,o.kt)("a",{parentName:"p",href:"http://mikro-orm.io/docs/entity-manager"},"EntityManager")," or you can use ",(0,o.kt)("a",{parentName:"p",href:"#using-entity-factories"},"Factories"),"."),(0,o.kt)("p",null,"You can create your own seeder classes using the following CLI command:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"npx mikro-orm seeder:create DatabaseSeeder\n")),(0,o.kt)("p",null,"This creates a new seeder class. By default it will be generated in the ",(0,o.kt)("inlineCode",{parentName:"p"},"./database/seeder/")," directory. You can configure the directory in the config with the key ",(0,o.kt)("inlineCode",{parentName:"p"},"seeder.path"),"."),(0,o.kt)("p",null,"As an example we will look at a very basic seeder."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"// ./database/seeder/database.seeder.ts\n\nimport { EntityManager } from '@mikro-orm/core';\nimport { Seeder } from '@mikro-orm/seeder';\nimport { Author } from './author'\n\nexport class DatabaseSeeder extends Seeder {\n\n  async run(em: EntityManager): Promise<void> {\n    const author = em.create(Author, {\n      name: 'John Snow',\n      email: 'snow@wall.st'\n    });\n  }\n}\n")),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"Running a seeder from the command line or programmatically will automatically call ",(0,o.kt)("inlineCode",{parentName:"p"},"flush")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"clear")," after the ",(0,o.kt)("inlineCode",{parentName:"p"},"run")," method has completed.")),(0,o.kt)("h3",{id:"using-entity-factories"},"Using entity factories"),(0,o.kt)("p",null,"Instead of specifying all the attributes for every entity, you can also use ",(0,o.kt)("a",{parentName:"p",href:"#entity-factories"},"entity factories"),". These can be used to generate large amounts of database records. Please read the ",(0,o.kt)("a",{parentName:"p",href:"#entity-factories"},"documentation on how to define factories")," to learn how to define your factories. "),(0,o.kt)("p",null,"As an example we will generate 10 authors."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"import { EntityManager } from '@mikro-orm/core';\nimport { Seeder } from '@mikro-orm/seeder';\nimport { AuthorFactory } from '../factories/author.factory'\n\nexport class DatabaseSeeder extends Seeder {\n\n  async run(em: EntityManager): Promise<void> {\n    new AuthorFactory(em).count(10).make()\n  }\n}\n")),(0,o.kt)("h3",{id:"calling-additional-seeders"},"Calling additional seeders"),(0,o.kt)("p",null,"Inside the ",(0,o.kt)("inlineCode",{parentName:"p"},"run")," method you can specify other seeder classes. You can use the ",(0,o.kt)("inlineCode",{parentName:"p"},"call")," method to breakup the database seeder into multiple files to prevent a seeder file from becoming too large. The ",(0,o.kt)("inlineCode",{parentName:"p"},"call")," method accepts an array of seeder classes."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"import { EntityManager } from '@mikro-orm/core';\nimport { Seeder } from '@mikro-orm/seeder';\nimport { AuthorSeeder, BookSeeder } from '../seeders'\n\nexport class DatabaseSeeder extends Seeder {\n\n  run(em: EntityManager): Promise<void> {\n    return this.call(em, [\n      AuthorSeeder,\n      BookSeeder\n    ]);\n  }\n}\n")),(0,o.kt)("h2",{id:"entity-factories"},"Entity factories"),(0,o.kt)("p",null,"When testing you may insert entities in the database before starting a test. Instead of specifying every attribute of every entity by hand, you could also use a ",(0,o.kt)("inlineCode",{parentName:"p"},"Factory")," to define a set of default attributes for an entity using entity factories."),(0,o.kt)("p",null,"Lets have a look at an example factory for an ",(0,o.kt)("a",{parentName:"p",href:"http://mikro-orm.io/docs/defining-entities"},"Author entity"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Factory } from '@mikro-orm/seeder';\nimport Faker from 'faker';\nimport { Author } from './entities/author.entity';\n\nexport class AuthorFactory extends Factory<Author> {\n  model = Author;\n\n  definition(faker: typeof Faker): Partial<Author> {\n    return {\n      name: faker.person.findName(),\n      email: faker.internet.email(),\n      age: faker.random.number(18, 99)\n    };\n  }\n}\n")),(0,o.kt)("p",null,"Basically you extend the base ",(0,o.kt)("inlineCode",{parentName:"p"},"Factory")," class, define a ",(0,o.kt)("inlineCode",{parentName:"p"},"model")," property and a ",(0,o.kt)("inlineCode",{parentName:"p"},"definition")," method. The ",(0,o.kt)("inlineCode",{parentName:"p"},"model")," defines for which entity the factory generates entity instances. The ",(0,o.kt)("inlineCode",{parentName:"p"},"definition")," method returns the default set of attribute values that should be applied when creating an entity using the factory."),(0,o.kt)("p",null,"Via the faker property, factories have access to the ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/marak/Faker.js/"},"Faker library"),", which allows you to conveniently generate various kinds of random data for testing."),(0,o.kt)("h3",{id:"creating-entities-using-factories"},"Creating entities using factories"),(0,o.kt)("p",null,"Once you defined your factories you can use them to generate entities. Simply import the factory, instantiate it and call the ",(0,o.kt)("inlineCode",{parentName:"p"},"makeOne")," method."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"const author: Author = new AuthorFactory(orm.em).makeOne();\n")),(0,o.kt)("h4",{id:"generate-multiple-entities"},"Generate multiple entities"),(0,o.kt)("p",null,"Generate multiple entities by calling the ",(0,o.kt)("inlineCode",{parentName:"p"},"make")," method. The parameter of the ",(0,o.kt)("inlineCode",{parentName:"p"},"make")," method is the number of entities you generate."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"// Generate 5 authors\nconst authors: Author[] = new AuthorFactory(orm.em).make(5);\n")),(0,o.kt)("h4",{id:"overriding-attributes"},"Overriding attributes"),(0,o.kt)("p",null,"If you would like to override some of the default values of your factories, you may pass an object to the make method. Only the specified attributes will be replaced while the rest of the attributes remain set to their default values as specified by the factory."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"const author: Author = new AuthorFactory(orm.em).make({\n    name: 'John Snow'\n});\n")),(0,o.kt)("h3",{id:"persisting-entities"},"Persisting entities"),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"create")," method instantiates entities and persists them to the database using the ",(0,o.kt)("inlineCode",{parentName:"p"},"persistAndFlush")," method of the EntityManager."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"// Make and persist a single author\nconst author: Author = await new AuthorFactory(orm.em).createOne();\n\n// Make and persist 5 authors\nconst authors: Author[] = await new AuthorFactory(orm.em).create(5);\n")),(0,o.kt)("p",null,"You can override the default values of your factories by passing an object to the ",(0,o.kt)("inlineCode",{parentName:"p"},"create")," method."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"// Make and persist a single author\nconst author: Author = await new AuthorFactory(orm.em).createOne({\n    name: 'John Snow'\n});\n\n// Make and persist a 5 authors\nconst authors: Author[] = await new AuthorFactory(orm.em).create(5, {\n    name: 'John Snow'\n});\n")),(0,o.kt)("h3",{id:"factory-relationships"},"Factory relationships"),(0,o.kt)("p",null,"It is nice to create large quantities of data for one entity, but most of the time we want to create data for multiple entities and also have relations between these. For this we can use the ",(0,o.kt)("inlineCode",{parentName:"p"},"each")," method which can be chained on a factory. The ",(0,o.kt)("inlineCode",{parentName:"p"},"each")," method can be called with a function that transforms output entity from the factory before returning it. Lets look at some examples for the different relations."),(0,o.kt)("h4",{id:"manytoone-and-onetoone-relations"},"ManyToOne and OneToOne relations"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"const books: Book[] = new BookFactory(orm.em).each(book => {\n    book.author = new AuthorFactory(orm.em).makeOne();\n}).make(5);\n")),(0,o.kt)("h4",{id:"onetomany-and-manytomany"},"OneToMany and ManyToMany"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"const books: Book[] = new BookFactory(orm.em).each(book => {\n    book.owners.set(new OwnerFactory(orm.em).make(5));\n}).make(5);\n")),(0,o.kt)("h2",{id:"use-with-cli"},"Use with CLI"),(0,o.kt)("p",null,"You may execute the ",(0,o.kt)("inlineCode",{parentName:"p"},"seeder:run")," MikroORM CLI command to seed your database. By default, the ",(0,o.kt)("inlineCode",{parentName:"p"},"seeder:run")," command runs the DatabaseSeeder class, which may in turn invoke other seed classes. However, you may use the ",(0,o.kt)("inlineCode",{parentName:"p"},"--class")," option to specify a specific seeder class to run individually:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell",metastring:"script",script:!0},"npx mikro-orm seeder:run\n\nnpx mikro-orm seeder:run --class=BookSeeder\n")),(0,o.kt)("p",null,"You may also seed your database using the ",(0,o.kt)("a",{parentName:"p",href:"/docs/next/migrations#using-via-cli"},(0,o.kt)("inlineCode",{parentName:"a"},"migrate:fresh"))," or ",(0,o.kt)("a",{parentName:"p",href:"/docs/next/schema-generator"},(0,o.kt)("inlineCode",{parentName:"a"},"schema:fresh"))," command in combination with the ",(0,o.kt)("inlineCode",{parentName:"p"},"--seed")," option, which will drop all tables and re-run all of your migrations or generate the database based on the current entities. This command is useful for completely re-building your database:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell",metastring:"script",script:!0},"npx mikro-orm migration:fresh --seed\n\nnpx mikro-orm schema:fresh --seed\n")),(0,o.kt)("h2",{id:"use-in-tests"},"Use in tests"),(0,o.kt)("p",null,"Now we know how to create seeders and factories, but how can we effectively use them in tests. We will show an example how it can be used."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"beforeAll(async () => {\n    // Get seeder from MikroORM\n    const seeder = orm.getSeeder();\n    \n    // Refresh the database to start clean\n    await seeder.refreshDatabase();\n    \n    // Seed using a seeder defined by you\n    await seeder.seed(DatabaseSeeder);\n})\n\ntest(() => {\n    // Do tests\n});\n\nafterAll(async () => {\n    // Close connection\n    await orm.close();\n})\n")))}u.isMDXComponent=!0}}]);